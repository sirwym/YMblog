{% extends "base.html" %}
{% load static %}

{% block title %}AIæµ‹è¯•æ•°æ®ç”Ÿæˆå™¨{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 h-[90vh] flex flex-col"
     x-data="testGenApp()"
     x-init="downloadUrlTemplate = $el.dataset.downloadUrlTemplate"
     data-download-url-template="{% url 'tools:download_zip' '00000000-0000-0000-0000-000000000000' %}">

    <div class="flex justify-between items-center mb-4 shrink-0">
        <div class="flex items-center gap-4">
            <h1 class="text-2xl font-bold flex items-center gap-2">
                AIæµ‹è¯•æ•°æ®ç”Ÿæˆå·¥åŠ
            </h1>

            <div class="tooltip tooltip-right" data-tip="1.è¾“å…¥é¢˜ç›® -> 2.AIç”Ÿæˆä»£ç  -> 3.ç”Ÿæˆæµ‹è¯•ç‚¹">
                <button class="btn btn-circle btn-ghost btn-xs">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="w-4 h-4 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </button>
            </div>
        </div>

        <div class="flex gap-2">
            <select class="select  select-ghost join-item" x-model.number="genCount">
                <option value="5">5 ç»„</option>
                <option value="10">10 ç»„</option>
                <option value="20">20 ç»„</option>
            </select>
            <button class="btn bg-base-200 text-primary border-0 hover:bg-base-300"
                    @click="askAI"
                    :disabled="aiLoading">
                <span x-show="aiLoading" class="loading loading-spinner loading-sm"></span>
                <svg x-show="!aiLoading" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456ZM16.894 20.567 16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423Z" /></svg>
                1. AIç”Ÿæˆä»£ç 
            </button>

            <button class="btn btn-primary"
                    @click="startGeneration"
                    :disabled="isRunning">
                <span x-show="isRunning" class="loading loading-spinner loading-sm"></span>
                <span x-show="!isRunning" class="flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z" /></svg>
                    2. è¿è¡Œæµ‹è¯•
                </span>
                <span x-show="isRunning">è¿è¡Œä¸­...</span>
            </button>

            <a x-show="zipId"
               :href="getDownloadUrl()"
               target="_blank"
               class="btn btn-success text-white">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
               ä¸‹è½½æ•°æ®åŒ…
            </a>
        </div>
    </div>

    <div class="collapse collapse-arrow bg-base-200 mb-4 shrink-0">
        <input type="checkbox" />
        <div class="collapse-title text-sm font-medium py-2 min-h-0 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" /></svg>
            ä½¿ç”¨è¯´æ˜ & æç¤º
        </div>
        <div class="collapse-content text-xs opacity-70">
            <p>1. åœ¨ <b>é¢˜ç›®æè¿°</b> ä¸­ç²˜è´´é¢˜é¢ï¼Œåœ¨ <b>æ ‡å‡†ç¨‹åº</b> ä¸­ç²˜è´´æ­£ç¡®çš„ C++ ä»£ç ã€‚</p>
            <p>2. ç‚¹å‡»é¡¶éƒ¨ <b>AIç”Ÿæˆä»£ç </b>ï¼Œè‡ªåŠ¨ç¼–å†™ç”Ÿæˆå™¨ (gen.py) å’Œæ ¡éªŒå™¨ (val.py)ã€‚</p>
            <p>3. æ£€æŸ¥ä»£ç æ— è¯¯åï¼Œç‚¹å‡» <b>è¿è¡Œæµ‹è¯•</b>ï¼Œç³»ç»Ÿå°†ç”Ÿæˆæµ‹è¯•æ•°æ®å¹¶éªŒè¯æ ‡ç¨‹ã€‚</p>
            <p>4. ç»“æœæ»¡æ„åå¯ç‚¹å‡» <b>ä¸‹è½½æ•°æ®åŒ…</b> è·å– .zip æ ¼å¼çš„æµ‹è¯•ç‚¹ã€‚</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-1 min-h-0">

        <div class="lg:col-span-1 flex flex-col h-full overflow-hidden">
            <div class="card bg-base-100 shadow-md h-full border border-base-200 overflow-hidden flex flex-col">
                <div class="p-3 bg-base-200 font-bold text-xs flex justify-between items-center shrink-0">
                    <span>ç”Ÿæˆç»“æœ</span>
                    <span class="badge badge-neutral badge-sm" x-text="results.length + ' ä¸ªæµ‹è¯•ç‚¹'"></span>
                </div>

                <div class="overflow-y-auto flex-1 p-2 custom-scrollbar">
                    <template x-for="res in results" :key="res.id">
                        <div class="collapse collapse-arrow border border-base-300 bg-base-100 mb-2 rounded-md">
                            <input type="checkbox" />
                            <div class="collapse-title text-sm font-mono flex items-center justify-between py-2 min-h-0">
                                <div class="flex items-center gap-2">
                                    <span class="badge badge-sm" x-text="'#' + res.id"></span>
                                    <span class="font-bold" :class="{
                                        'text-success': res.status === 'Accepted',
                                        'text-error': res.status.includes('Error') || res.status.includes('Invalid'),
                                        'text-warning': res.status === 'Time Limit Exceeded'
                                    }" x-text="res.status"></span>
                                </div>
                                <div class="text-xs opacity-50 font-mono">
                                    <span x-text="res.time + 'ms'"></span> / <span x-text="res.memory + 'KB'"></span>
                                </div>
                            </div>
                            <div class="collapse-content text-xs font-mono bg-base-200">
                                <div class="pt-2 grid grid-cols-1 gap-2">
                                    <div>
                                        <div class="opacity-50 mb-1">Input Preview (Seed: <span x-text="res.seed"></span>)</div>
                                        <div class="mockup-code bg-[#1e1e1e] text-[#d4d4d4] p-2 min-h-[3rem] max-h-[8rem] overflow-auto whitespace-pre-wrap text-[10px]" x-text="res.input_preview"></div>
                                    </div>
                                    <div>
                                        <div class="opacity-50 mb-1">Output Preview</div>
                                        <div class="mockup-code bg-[#1e1e1e] text-[#d4d4d4] p-2 min-h-[3rem] max-h-[8rem] overflow-auto whitespace-pre-wrap text-[10px]" x-text="res.output_preview"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>

                    <div x-show="results.length === 0" class="flex flex-col items-center justify-center h-full opacity-30 gap-2">
                        <span class="text-4xl">ğŸ“¦</span>
                        <span class="text-sm">æš‚æ— æ•°æ®</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2 h-full overflow-hidden flex flex-col shadow-md rounded-box border border-base-200 bg-base-100">

    <div class="flex border-b border-base-300 bg-base-200/50 overflow-x-auto shrink-0">
        <label class="cursor-pointer px-4 py-3 text-xs font-bold border-b-2 transition-colors flex items-center gap-2 hover:bg-base-200"
               :class="activeTab === 'desc' ? 'border-primary text-primary bg-base-100' : 'border-transparent opacity-60'">
            <input type="radio" name="editor_tabs" value="desc" x-model="activeTab" class="hidden" />
            <span class="w-2 h-2 rounded-full bg-base-content/50"></span>
            1. é¢˜ç›®æè¿°
        </label>

        <label class="cursor-pointer px-4 py-3 text-xs font-bold border-b-2 transition-colors flex items-center gap-2 hover:bg-base-200"
               :class="activeTab === 'sol' ? 'border-blue-500 text-blue-600 bg-base-100' : 'border-transparent opacity-60'">
            <input type="radio" name="editor_tabs" value="sol" x-model="activeTab" class="hidden" />
            <span class="w-2 h-2 rounded-full bg-blue-500"></span>
            2. æ ‡å‡†ç¨‹åº (C++)
        </label>

        <label class="cursor-pointer px-4 py-3 text-xs font-bold border-b-2 transition-colors flex items-center gap-2 hover:bg-base-200"
               :class="activeTab === 'gen' ? 'border-yellow-500 text-yellow-600 bg-base-100' : 'border-transparent opacity-60'">
            <input type="radio" name="editor_tabs" value="gen" x-model="activeTab" class="hidden" />
            <span class="w-2 h-2 rounded-full bg-yellow-500"></span>
            3. ç”Ÿæˆå™¨ (Python)
        </label>

        <label class="cursor-pointer px-4 py-3 text-xs font-bold border-b-2 transition-colors flex items-center gap-2 hover:bg-base-200"
               :class="activeTab === 'val' ? 'border-purple-500 text-purple-600 bg-base-100' : 'border-transparent opacity-60'">
            <input type="radio" name="editor_tabs" value="val" x-model="activeTab" class="hidden" />
            <span class="w-2 h-2 rounded-full bg-purple-500"></span>
            4. æ ¡éªŒå™¨ (Python)
        </label>
    </div>

    <div class="flex-1 relative bg-[#1e1e1e] overflow-hidden">

        <div x-show="activeTab === 'desc'" class="absolute inset-0 w-full h-full" x-transition.opacity.duration.200ms>
            <textarea x-model="description"
                class="w-full h-full p-6 bg-transparent text-[#d4d4d4] font-sans text-base resize-none focus:outline-none leading-relaxed placeholder-white/20 overflow-auto"
                placeholder="è¯·åœ¨æ­¤ç²˜è´´é¢˜ç›®æè¿°..."
            ></textarea>
        </div>

        <div x-show="activeTab === 'sol'" class="absolute inset-0 w-full h-full" x-transition.opacity.duration.200ms>
            <textarea x-model="solutionCode"
                class="w-full h-full p-4 bg-transparent text-[#d4d4d4] font-mono text-sm resize-none focus:outline-none leading-relaxed placeholder-white/20 overflow-auto"
                spellcheck="false"
                @keydown.tab.prevent="$el.setRangeText('    ', $el.selectionStart, $el.selectionStart, 'end')"
            ></textarea>
        </div>

        <div x-show="activeTab === 'gen'" class="absolute inset-0 w-full h-full" x-transition.opacity.duration.200ms>
            <textarea x-model="genCode"
                class="w-full h-full p-4 bg-transparent text-[#d4d4d4] font-mono text-sm resize-none focus:outline-none leading-relaxed placeholder-white/20 overflow-auto"
                spellcheck="false"
                @keydown.tab.prevent="$el.setRangeText('    ', $el.selectionStart, $el.selectionStart, 'end')"
            ></textarea>
        </div>

        <div x-show="activeTab === 'val'" class="absolute inset-0 w-full h-full" x-transition.opacity.duration.200ms>
            <textarea x-model="valCode"
                class="w-full h-full p-4 bg-transparent text-[#d4d4d4] font-mono text-sm resize-none focus:outline-none leading-relaxed placeholder-white/20 overflow-auto"
                spellcheck="false"
                placeholder="# åœ¨è¿™é‡Œç¼–å†™æ ¡éªŒå™¨..."
                @keydown.tab.prevent="$el.setRangeText('    ', $el.selectionStart, $el.selectionStart, 'end')"
            ></textarea>
        </div>

    </div>
</div>

    </div>
</div>

<script>
function testGenApp() {
    return {
        activeTab: 'desc',
        description: '',
        results: [],
        zipId: null,
        isRunning: false,
        aiLoading: false,
        genCount: 5,

        // æ–°å¢ï¼šç”¨äºå­˜å‚¨ä¸‹è½½é“¾æ¥æ¨¡æ¿çš„å˜é‡
        downloadUrlTemplate: '',

        solutionCode: `#include <iostream>
using namespace std;
int main() {
    int n;
    if(cin >> n) cout << n << endl;
    return 0;
}`,
        genCode: `import sys, random
seed = int(sys.argv[1]) if len(sys.argv) > 1 else 0
random.seed(seed)
print(random.randint(1, 100))`,

        valCode: `import sys
# è¯»å–ç”Ÿæˆçš„æ•°æ® (stdin)
# data = sys.stdin.read()
# if not valid: sys.exit(1)
pass`,

        getDownloadUrl() {
            // ä¿®å¤ç‚¹ï¼šç›´æ¥ä½¿ç”¨ x-init ä¸­åˆå§‹åŒ–å¥½çš„å˜é‡ï¼Œä¸å†è®¿é—® this.$root
            return this.downloadUrlTemplate.replace('00000000-0000-0000-0000-000000000000', this.zipId);
        },

        async askAI() {
            if (!this.description) { alert('è¯·å…ˆå¡«å†™é¢˜ç›®æè¿°'); this.activeTab = 'desc'; return; }
            this.aiLoading = true;
            try {
                const res = await fetch('{% url "tools:api_ai_generate" %}', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
                    body: JSON.stringify({ description: this.description, solution: this.solutionCode })
                });
                const data = await res.json();
                if(data.gen_code) {
                    this.genCode = data.gen_code;
                    this.activeTab = 'gen';
                }
                if(data.val_code) {
                    this.valCode = data.val_code;
                }
            } catch(e) {
                alert('AI ç”Ÿæˆå¤±è´¥: ' + e);
            } finally {
                this.aiLoading = false;
            }
        },

        async startGeneration() {
            this.isRunning = true;
            this.results = [];
            this.zipId = null;
            try {
                const res = await fetch('{% url "tools:api_run_testgen" %}', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
                    body: JSON.stringify({
                        solution: this.solutionCode,
                        gen_code: this.genCode,
                        val_code: this.valCode,
                        count: this.genCount
                    })
                });
                const data = await res.json();

                if (data.status === 'OK') {
                    this.results = data.results;
                    this.zipId = data.zip_id;
                } else {
                    alert('é”™è¯¯: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch(e) {
                alert('è¿è¡Œå¤±è´¥: ' + e);
            } finally {
                this.isRunning = false;
            }
        }
    }
}
</script>
{% endblock %}