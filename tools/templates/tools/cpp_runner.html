{% extends "base.html" %}
{% load static %}

{% block title %}在线 C++ 工具箱{% endblock %}

{% block extra_head %}
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e1e1e; }
    </style>
{% endblock %}

{% block content %}

    <script>
        window.MonacoEnvironment = {
            getWorkerUrl: function (workerId, label) {
                const origin = window.location.origin;
                const vsPath = origin + "{% static 'monaco/vs' %}";
                const workerPath = origin + "{% static 'monaco/vs/base/worker/workerMain.js' %}";
                const baseUrl = vsPath.replace(/\/vs\/?$/, '');
                return `data:text/javascript;charset=utf-8,${encodeURIComponent(`
                self.MonacoEnvironment = { baseUrl: '${baseUrl}' };
                importScripts('${workerPath}');`
                )}`;
            }
        };
    </script>

    <script>
        function cppRunner() {
            return {
                editor: null,
                inputData: '',
                outputData: '',
                isLoading: false,
                theme: 'vs-dark',
                useO2: true,

                // 新增状态字段
                sysInfo: { compiler: '检测中...', limit: '...' },
                executionTime: null,
                executionMemory: null,
                resultStatus: null,

                init() {
                    // 1. 获取系统信息
                    this.fetchSysInfo();

                    // 2. 加载编辑器
                    if (window.monaco) { this.createEditor(); return; }

                    const script = document.createElement('script');
                    script.src = "{% static 'monaco/vs/loader.js' %}";
                    script.async = true;
                    script.onload = () => { this.configAndLoad(); };
                    document.body.appendChild(script);
                },

                // 新增：获取编译器版本
                async fetchSysInfo() {
                    try {
                        const res = await fetch('{% url "tools:sys_info" %}');
                        const data = await res.json();
                        this.sysInfo.compiler = data.compiler;
                        this.sysInfo.limit = data.memory_limit;
                    } catch(e) {
                        this.sysInfo.compiler = '连接服务器失败';
                    }
                },

                configAndLoad() {
                    require.config({ paths: { 'vs': '{% static "monaco/vs" %}' }});
                    const self = this;
                    require(['vs/editor/editor.main'], function() { self.createEditor(); });
                },

                createEditor() {
                    const container = document.getElementById('monaco-container');
                    if (!container) return;
                    container.innerHTML = '';
                    this.editor = monaco.editor.create(container, {
                        value: '#include <iostream>\n\nint main() {\n    std::cout << "Hello, World!" << std::endl;\n    return 0;\n}',
                        language: 'cpp',
                        theme: this.theme,
                        automaticLayout: true,
                        minimap: { enabled: false },
                        fontSize: 14
                    });
                },

                changeTheme() {
                    if (this.editor) monaco.editor.setTheme(this.theme);
                },

                async runCode() {
                    if (!this.editor) return;
                    this.isLoading = true;
                    this.outputData = '编译运行中...';
                    this.resultStatus = null;
                    this.executionTime = null; // 重置

                    const code = this.editor.getValue();

                    try {
                        const response = await fetch('{% url "tools:run_cpp_api" %}', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                            body: JSON.stringify({ code: code, input: this.inputData, use_o2: this.useO2})
                        });

                        const data = await response.json();

                        if (!response.ok) throw new Error(data.error || 'Server Error');

                        if (data.status === 'Compile Error') {
                            this.outputData = data.output;
                            this.resultStatus = 'Compile Error';
                        } else {
                            this.outputData = data.output || '(程序无输出)';
                            this.resultStatus = data.status;
                            // 更新时间和内存
                            this.executionTime = data.time ? data.time.toFixed(0) : 0;
                            this.executionMemory = data.memory ? data.memory.toFixed(0) : 0;
                        }
                    } catch(e) {
                        this.outputData = e.message;
                        this.resultStatus = 'Error';
                    } finally {
                        this.isLoading = false;
                    }
                }
            }
        }
    </script>

    <div class="container mx-auto px-4 py-8" x-data="cppRunner()" x-init="init()">
        <div class="flex flex-col lg:flex-row gap-6 h-[80vh]">
            <div class="flex-1 flex flex-col gap-2">

                <div class="flex flex-col md:flex-row justify-between items-center bg-base-200 p-2 rounded-lg gap-2">
                    <div class="flex flex-col items-center">
                        <h2 class="text-xl font-bold flex items-center gap-2 pl-2">
                            <span class="text-blue-500">C++</span> 编辑器
                        </h2>
                        <div class="text-xs opacity-60 pl-2 font-mono flex gap-2">
                            <span x-text="sysInfo.compiler" class="truncate max-w-[200px]" title="编译器版本"></span>
                            <span class="hidden md:inline">|</span>
                            <span>Limit: <span x-text="sysInfo.limit"></span>MB</span>
                        </div>
                    </div>

                    <div class="flex items-center gap-3">
                        <label class="label cursor-pointer gap-2 border-r border-base-300 pr-3 mr-1">
                            <span class="label-text text-xs font-bold">O2优化</span>
                            <input type="checkbox" x-model="useO2" class="checkbox checkbox-xs checkbox-primary" />
                        </label>
                        <select x-model="theme" @change="changeTheme" class="select select-bordered select-sm w-32">
                            <option value="vs">浅色 (Light)</option>
                            <option value="vs-dark">深色 (Dark)</option>
                            <option value="hc-black">高对比</option>
                        </select>

                        <button @click="runCode" :disabled="isLoading" class="btn btn-primary btn-sm gap-2">
                            <span x-show="isLoading" class="loading loading-spinner loading-xs"></span>
                            <span x-text="isLoading ? '运行中...' : '运行 (Run)'"></span>
                            <svg x-show="!isLoading" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>

                <div id="monaco-container"
                     class="flex-1 rounded-box overflow-hidden shadow-lg border border-base-300 bg-[#1e1e1e]"
                     style="min-height: 500px;">
                    <div class="h-full flex items-center justify-center text-gray-500">正在初始化编辑器...</div>
                </div>
            </div>

            <div class="w-full lg:w-1/3 flex flex-col gap-4">
                <div class="flex flex-col gap-2 h-1/3">
                    <label class="font-bold text-sm opacity-70">标准输入 (Stdin)</label>
                    <textarea x-model="inputData" class="textarea textarea-bordered h-full font-mono text-sm resize-none"></textarea>
                </div>
                <div class="flex flex-col gap-2 flex-1">
                    <div class="flex justify-between items-center px-1">
                        <label class="font-bold text-sm opacity-70">运行结果</label>

                        <template x-if="resultStatus">
                            <div class="flex gap-2">
                                <div class="badge badge-sm" :class="resultStatus === 'Accepted' ? 'badge-success' : 'badge-error'" x-text="resultStatus"></div>
                            </div>
                        </template>
                    </div>

                    <div class="mockup-code bg-[#1e1e1e] text-gray-300 h-full overflow-y-auto custom-scrollbar relative">
                        <pre class="px-5 py-3"><code x-text="outputData || '等待运行...'"></code></pre>
                    </div>

                    <div class="stats stats-horizontal shadow bg-base-200 w-full" x-show="executionTime !== null">
                        <div class="stat place-items-center text-center py-4 flex-1">
                            <div class="stat-title text-xs opacity-70">Time</div>
                            <div class="stat-value text-sm text-primary mb-0.5"><span x-text="executionTime"></span> ms</div>
                        </div>

                        <div class="stat place-items-center text-center py-4 flex-1 border-l border-base-300"> <div class="stat-title text-xs opacity-70">Memory</div>
                            <div class="stat-value text-sm text-secondary mb-0.5"><span x-text="executionMemory"></span> KB</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}