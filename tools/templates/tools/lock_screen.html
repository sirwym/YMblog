{% extends "base.html" %}

{% block title %}访问受限{% endblock %}

{% block content %}
<div class="min-h-[60vh] flex items-center justify-center">
    <div class="card w-96 bg-base-100 shadow-xl border border-base-200">
        <div class="card-body items-center text-center">
            <div class="w-16 h-16 rounded-full bg-warning/10 flex items-center justify-center mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-warning" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
            </div>

            <h2 class="card-title text-2xl font-bold">需要访问密码</h2>
            <p class="text-base-content/70">工具 <span class="font-bold text-primary">{{ tool.title }}</span> 已被加密</p>

            <div class="form-control w-full max-w-xs mt-4" x-data="lockScreenData()">
                <input type="password"
                       x-model="password"
                       placeholder="请输入访问密码"
                       class="input input-bordered w-full text-center"
                       @keyup.enter="unlock"
                       :class="{'input-error': error}"
                />

                <label class="label min-h-[2rem]" x-show="error" x-transition>
                    <span class="label-text-alt text-error" x-text="error"></span>
                </label>

                <div class="card-actions justify-center mt-2 w-full">
                    <button class="btn btn-primary w-full"
                            @click="unlock"
                            :disabled="loading">
                        <span x-show="loading" class="loading loading-spinner"></span>
                        <span x-show="!loading">解锁访问</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function lockScreenData() {
        return {
            loading: false,
            password: '',
            error: '',

            unlock() {
                // 1. 简单校验
                if (!this.password) {
                    this.error = '请输入密码';
                    return;
                }

                // 2. 设置状态
                this.loading = true;
                this.error = '';

                // 3. 发送请求
                fetch('{% url "tools:api_unlock" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        tool_id: {{ tool.id }}, // Django 渲染 ID
                        password: this.password
                    })
                })
                .then(response => {
                    if (!response.ok) throw new Error('网络请求错误');
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // 解锁成功，刷新当前页面（会自动进入工具页）
                        window.location.reload();
                    } else {
                        // 显示后端返回的错误信息
                        this.error = data.message || '密码错误';
                    }
                })
                .catch(err => {
                    console.error(err);
                    this.error = '网络请求失败，请检查连接';
                })
                .finally(() => {
                    this.loading = false;
                });
            }
        }
    }
</script>
{% endblock %}